{layout '../layouts/base.latte'}

{block title}MyCloud{/block}
{block head}{/block}
{block nav}
<nav class="navbar is-primary" role="navigation" aria-label="main navigation">
  <div class="navbar-menu"> 
    <div class="navbar-start"> 
      {* <a class="navbar-item">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a>  *}
    </div> 
    <div class="navbar-item is-expanded is-justify-content-center">
  <div class="navbar-brand"> 
    <a class="navbar-item" href="/"> <strong>MyCloud</strong> </a> 
  </div> 
    </div> 
    <div class="navbar-end"> 
      <a class="navbar-item">ğŸ”” é€šçŸ¥</a> 
      <a class="navbar-item">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a> 
    </div> 
  </div>
</nav>
{/block}
{block content}
  <section>
  <div id="folder-root" data-current-path="{$currentPath}"></div>
  <div class="has-background-primary p-2" style="display: flex; align-items: center; justify-content: space-between;">
  <!-- å·¦å´ï¼šã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div class="is-flex is-align-items-center" style="gap: 0.5rem;">
  {=renderComponent('breadcrumbs',['breadcrumbs' => $breadcrumbs])|noescape}
  </div>
  <div> 
    <sl-input placeholder="æ¤œç´¢..." clearable size="small"> 
      <sl-icon slot="prefix" name="search" size="small"></sl-icon> 
    </sl-input>
  </div>  
  <!-- å³å´ï¼šãƒ„ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div class="is-flex is-align-items-center" style="gap: 0.5rem;">
    <sl-icon-button name="folder-plus" label="ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ" id="create-folder-btn"></sl-icon-button>
    <sl-icon-button name="trash" label="å‰Šé™¤"></sl-icon-button>
  </div>
  </div>
    <div class="container" style="border:1px solid grey">
      <div class="icon-grid"
        data-folder-path="{$currentPath}"
      >
      {foreach $folders as $folder}
        <div 
          class="icon-item" 
          draggable="true"
          data-type="folder"
          data-folder-name="{$folder->name}"
          data-folder-path="{$currentPath}/{$folder->name}"
          onclick="openFolder(event)"
        >
          <sl-icon-button
            name="folder"
            label="{$folder->name}"
            draggable="false"
            >
          </sl-icon-button>
          <div>{$folder->name}</div>
        </div>
      {/foreach}
      {foreach $files as $file}
  <div 
    class="icon-item"
    draggable="true"
    data-type="file"
    data-file-name="{$file->logical_name}"
    onclick="location.href = '/view/{$file->versions[0]->id}'"
  >
    <sl-icon-button
      name="{getIconName($file->versions[0]->mime_type)}"
      label="{$file->logical_name}"
       draggable="false"
      >
    </sl-icon-button>
    <div>{$file->logical_name}</div>
  </div>
{/foreach}
      </div>
    </div>
  </section>
 {=renderComponent('overlay',[])|noescape}
 <loading-overlay id="global-overlay"></loading-overlay>
  <!-- ãƒ€ã‚¤ã‚¢ãƒ­ã‚° --> 
<sl-dialog label="æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ" id="folder-dialog">
  <sl-input 
    id="folder-name" 
    label="ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›" 
    placeholder="ä¾‹: æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€" 
    help-text="" 
    pill 
    clearable>
  </sl-input>
  <sl-button slot="footer" variant="primary" id="create-btn">ä½œæˆ</sl-button>
  <sl-button slot="footer" variant="text" id="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</sl-button>
</sl-dialog>
{/block}
{block scripts}
<script n:syntax="off">
  function showProperties(event, name, versions) {
    event.preventDefault();
    const latest = versions[0];
    const versionList = versions.map(v =>
      `v${v.version} - ${v.size} bytes - ${new Date(v.uploaded_at).toLocaleString()}`
    ).join('\n');
    alert(`ğŸ“„ ${name}\n\nVersions:\n${versionList}`);
  }
</script>
<script n:syntax="off">
  function openFolder(event) {
  const path = event.currentTarget.dataset.path;
  console.log('Opening folder:', path);
  //location.href = `/folders/${path}`;
}
document.addEventListener('DOMContentLoaded', async () => {
  new ItemMove(".icon-grid");
  const dialog = document.getElementById('folder-dialog');
  const openBtn = document.getElementById('create-folder-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const createBtn = document.getElementById('create-btn');
  const input = document.getElementById('folder-name');
  const root = document.getElementById('folder-root');
  const currentPath = root.dataset.currentPath || '';
  const forbiddenChars = /[<>:"/\\|?*]/;

  openBtn.addEventListener('click', () => {
    console.log("c")
    input.value = '';
    input.setAttribute('help-text', '');
    input.removeAttribute('variant');
    dialog.show();
  });

  cancelBtn.addEventListener('click', () => {
    dialog.hide();
  });

  createBtn.addEventListener('click', async () => {
    const folderName = input.value.trim();
    if (forbiddenChars.test(folderName)) {
      input.setAttribute('help-text', 'ãƒ•ã‚©ãƒ«ãƒ€åã«ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™: < > : " / \\ | ? *');
      input.setAttribute('variant', 'danger');
      return;
    }

    if (!folderName) {
      input.setAttribute('help-text', 'ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      input.setAttribute('variant', 'danger');
      return;
    }

    input.setAttribute('help-text', '');
    input.removeAttribute('variant');
    dialog.hide();

    const targetPath = (currentPath != '') ? `${currentPath}/${folderName}` : '';
    console.log("targetPath",`/folders/${encodeURIComponent(targetPath)}`);
    console.log("currentpath",currentPath,(currentPath == ''));
    console.log("foldername",folderName);
    try {
      const res = await fetch(`/folders/${encodeURIComponent(targetPath)}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: folderName })
      });

      if (res.ok) {
        //location.reload();
      } else {
        const data = await res.json();
        alert(`ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error || res.statusText}`);
      }
    } catch (err) {
      alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
    }
  });
  // âŒ¨ï¸ Enterã‚­ãƒ¼ã§ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ 
  input.addEventListener('keydown', (event) => { 
    if (event.key === 'Enter') { 
      createBtn.click(); 
    } 
  });


});
</script>
<script>
//new ItemMove(".icon-grid");
class ItemMove {
  constructor(containerSelector = ".icon-grid") {
    this.container = document.querySelector(containerSelector);
    if (!this.container) {
      console.warn("ğŸ“¦ æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", containerSelector);
      return;
    }

    this.dialog = document.getElementById("overlay-dialog");
    this.dialogMessage = document.getElementById("overlay-message");

    this.prepareDraggableClasses();
    this.bindDraggables();
    this.bindDropTargets();
  }

  showOverlay(message = "å‡¦ç†ä¸­ã§ã™â€¦") {
    if (this.dialog && this.dialogMessage) {
      this.dialogMessage.textContent = message;
      this.dialog.show();
    }
  }

  hideOverlay(delay = 0) {
    if (this.dialog) {
      setTimeout(() => {
        this.dialog.hide();
      }, delay);
    }
  }

  prepareDraggableClasses() {
    const items = this.container.querySelectorAll(".icon-item");

    items.forEach(el => {
      const type = el.dataset.type;
      if (type === "folder") {
        el.classList.add("folder-draggable", "folder-drop-target");
        el.setAttribute("draggable", "true");
      } else if (type === "file") {
        el.classList.add("file-draggable");
        el.setAttribute("draggable", "true");
      }
    });
  }

  bindDraggables() {
    const draggables = this.container.querySelectorAll(".file-draggable, .folder-draggable");

    draggables.forEach(el => {
      el.addEventListener("dragstart", event => {
        const type = el.dataset.type;
        const name = type === "file" ? el.dataset.fileName : el.dataset.folderName;

        if (!type || !name) {
          console.warn("ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿å±æ€§ãŒã‚ã‚Šã¾ã›ã‚“", el);
          return;
        }

        const payload = JSON.stringify({ type, name });
        event.dataTransfer.setData("text/plain", payload);
        event.dataTransfer.effectAllowed = "move";
      });
    });
  }

  bindDropTargets() {
    const targets = this.container.querySelectorAll(".folder-drop-target");

    targets.forEach(folderEl => {
      folderEl.addEventListener("dragover", event => {
        event.preventDefault();
        event.dataTransfer.dropEffect = "move";
      });

      folderEl.addEventListener("dragenter", () => {
        folderEl.classList.add("drag-over");
      });

      folderEl.addEventListener("dragleave", () => {
        folderEl.classList.remove("drag-over");
      });

      folderEl.addEventListener("drop", event => {
        event.preventDefault();
        folderEl.classList.remove("drag-over");

        this.showOverlay("ç§»å‹•ä¸­â€¦");

        try {
          const raw = event.dataTransfer.getData("text/plain");
          if (!raw) throw new Error("ãƒ‰ãƒ­ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");

          const data = JSON.parse(raw);
          const { type: draggedType, name: draggedName } = data;
          const targetPath = folderEl.dataset.folderPath;
          const targetName = folderEl.dataset.folderName;

          if (!draggedType || !draggedName || !targetPath) {
            throw new Error("ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°å…ƒã®æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
          }

          if (draggedType === "file") {
            this.moveItem("file", draggedName, targetPath);
          } else if (draggedType === "folder" && draggedName !== targetName) {
            this.moveItem("folder", draggedName, targetPath);
          } else {
            this.showOverlay("âš ï¸ ç„¡åŠ¹ãªãƒ‰ãƒ­ãƒƒãƒ—æ“ä½œã§ã™");
            this.hideOverlay(2000);
          }
        } catch (err) {
          console.warn("âš ï¸ ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
          this.showOverlay("âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          this.hideOverlay(2000);
        }
      });
    });
  }

  moveItem(type, name, destinationPath) {
    console.log("ğŸ“¦ moveItem called:", { type, name, destinationPath });

    fetch('/move-item', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, name, destination: destinationPath })
    }).then(res => {
      if (res.ok) {
        location.reload();
      } else {
        this.showOverlay("âš ï¸ ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ");
        this.hideOverlay(2000);
      }
    }).catch(err => {
      console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
      this.showOverlay("âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      this.hideOverlay(2000);
    });
  }
}


</script>
<script>
{* const overlay = document.getElementById("global-overlay");

overlay.show("ç§»å‹•ä¸­â€¦");

// ã‚¨ãƒ©ãƒ¼æ™‚
overlay.show("âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
overlay.hide(2000); *}

class LoadingOverlay extends HTMLElement {
  constructor() {
    super();
    const shadow = this.attachShadow({ mode: 'open' });

    shadow.innerHTML = `
      <style>
        sl-dialog::part(panel) {
          background: rgba(255, 255, 255, 0.9);
          box-shadow: none;
          border: none;
        }
      </style>
      <sl-dialog id="dialog" no-header no-footer open>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1em;">
          <sl-spinner style="font-size: 2rem;"></sl-spinner>
          <div id="message">å‡¦ç†ä¸­ã§ã™â€¦</div>
        </div>
      </sl-dialog>
    `;
  }

  show(message = "å‡¦ç†ä¸­ã§ã™â€¦") {
    const dialog = this.shadowRoot.getElementById("dialog");
    const msg = this.shadowRoot.getElementById("message");
    if (dialog && msg) {
      msg.textContent = message;
      dialog.show();
    }
  }

  hide(delay = 0) {
    const dialog = this.shadowRoot.getElementById("dialog");
    if (dialog) {
      setTimeout(() => dialog.hide(), delay);
    }
  }
}

customElements.define('loading-overlay', LoadingOverlay);
</script>
{/block}
